# SACON NY 2019 Workshop

## Exercise 4: step-by-step solution

### Availability Service

- Copy the package `com.oreilly.sacon.library.availability` over to the new service. Remember to also copy the test package.

- Run the tests (`$ ./gradlew test`). `AvailabilityTest` should fail with a Hibernate error. This is because we also need to create the table in the new datastore. To do this:
  - Create a package inside `src/main/resources` called `db.migration`.
  - Create a file called `V1__Create_Item_Rating_Table.sql` with the following code:


  ````
    CREATE TABLE BOOK (
      id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    	available BIT DEFAULT FALSE
    );

    insert into BOOK (id, available)
    values (1,true);

    insert into BOOK (id, available)
    values (2,false);

    insert into BOOK (id, available)
    values (3,true);

    insert into BOOK (id, available)
    values (4,false);
  ````

- Run again the tests and ensure they are passing.

- Create a new package `com.oreilly.sacon.library.controllers` and controller inside called `AvailabilityController`:

````
package com.oreilly.sacon.library.controllers;


import com.oreilly.sacon.library.availability.Availability;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class AvailabilityController {

    @Autowired
    private Availability availability;

    @GetMapping(path = "/availability/{id}", produces = "application/json; charset=UTF-8")
    public BookAvailability rating(@PathVariable long id) {
        boolean available = availability.inStock(id);
        return new BookAvailability(available);
    }

    @PutMapping(path = "/borrow/{id}")
    public ResponseEntity borrow(@PathVariable long id) {
        availability.borrow(id);
        return new ResponseEntity(HttpStatus.OK);
    }
}
````

- Create the test for the class:

````
package com.oreilly.sacon.library.controllers;

import com.oreilly.sacon.library.availability.Availability;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;

import static org.mockito.Matchers.anyLong;
import static org.mockito.Mockito.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@RunWith(SpringRunner.class)
@SpringBootTest
@AutoConfigureMockMvc
public class AvailabilityControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private Availability availability;

    @Test
    public void shouldReturnAvailabilityInfoForABook() throws Exception {
        Long id = 1L;
        boolean expectedRating = true;
        when(availability.inStock(anyLong())).thenReturn(true);
        mockMvc.perform(MockMvcRequestBuilders.get("/availability/{id}", id))
                .andExpect(status().isOk())
                .andExpect(content().json("{'inStock':" + expectedRating + "}"));
    }

    @Test
    public void shouldChangeTheAvailabiltyOfABook() throws Exception {
        Long id = 1L;
        mockMvc.perform(MockMvcRequestBuilders.put("/borrow/{id}", id))
                .andExpect(status().isOk());

        verify(availability, atMost(1)).borrow(id);
    }
}
````

- Run all the tests (`$ ./gradlew test`).

- Run the application to check the new service.
`$ ./gradlew bootRun`
- Go to http://localhost:8090/availability/1

- If all is good, commit the changes.
````
$ git add .
$ git commit -m "Add Availability functionality to new service"
````

### Refactor the monolith to call the new service

- Create an `AvailabilityClient` in the availability package:

````
package com.oreilly.sacon.library.availability;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

@Service
public class AvailabilityClient {

    @Autowired
    private RestTemplate restTemplate;

    @Value("${availability.url}")
    private String availabilityUrl;

    public boolean inStock(long bookId) {
        Book book = restTemplate.getForObject(availabilityUrl + "availability/" + bookId, Book.class);
        return book.inStock();
    }

    public void borrow(long bookId) {
        HttpEntity<Long> requestUpdate = new HttpEntity<>(bookId);
        restTemplate.exchange(availabilityUrl + "borrow/", HttpMethod.PUT, requestUpdate, Void.class);
    }
}
````

- Also, add a test class `AvailabilityClientTest`:

````
package com.oreilly.sacon.library.availability;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.web.client.RestTemplate;

import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.is;
import static org.mockito.Mockito.*;
import static org.mockito.MockitoAnnotations.initMocks;

@RunWith(SpringRunner.class)
@SpringBootTest
public class AvailabilityClientTest {

    @Autowired
    private AvailabilityClient availabilityClient;

    @MockBean
    private RestTemplate restTemplate;

    @Value("${availability.url}")
    private String availabilityUrl;


    @Before
    public void setUp() {
        initMocks(this);
        when(restTemplate.getForObject(availabilityUrl + "1", Book.class)).thenReturn(new Book(true));
        when(restTemplate.getForObject(availabilityUrl + "2", Book.class)).thenReturn(new Book(false));
    }

    @Test
    public void shouldReturnItemAvailability() {
        assertThat(availabilityClient.inStock(1L), is(true));
        assertThat(availabilityClient.inStock(2L), is(false));
    }

    @Test
    public void shouldChangeBookAvailability() {
        availabilityClient.borrow(1L);
        verify(restTemplate, atMost(1)).put(availabilityUrl + "borrow", "1");
    }
}
````

- If you run these tests, there will be a few failures. To fix them:

  - Add the following property to `application.properties`
  ```
  availability.url=http://localhost:8090/
  ```

  - Configure the `RestTemplate` bean in `SaconLibraryApplication`. Add the following:
  ```
  @Bean
  public RestTemplate restTemplate() {
    return new RestTemplate();
  }
  ```

- Run the tests, they should work now.

- Finally, modify `CatalogController` so it uses the new client:

````
package com.oreilly.sacon.library.controllers;

import com.oreilly.sacon.library.availability.AvailabilityClient;
import com.oreilly.sacon.library.catalog.CatalogService;
import com.oreilly.sacon.library.catalog.Item;
import com.oreilly.sacon.library.models.BookWithAvailabilityAndRating;
import com.oreilly.sacon.library.rating.ItemRating;
import com.oreilly.sacon.library.rating.RatingService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;

import javax.servlet.http.HttpServletRequest;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.StreamSupport;

@Controller
public class CatalogController {

    @Autowired
    private CatalogService catalogService;

    @Autowired
    private AvailabilityClient availabilityClient;

    @Autowired
    private RatingService ratingService;

    @RequestMapping("/catalog")
    public String catalog(ModelMap model) {
        List<Item> books = catalogService.getAllBooks();
        List<BookWithAvailabilityAndRating> booksWithAvailability = addAvailability(books);
        model.addAttribute("books", booksWithAvailability);
        return "catalog";
    }

    private List<BookWithAvailabilityAndRating> addAvailability(List<Item> books) {
        List<BookWithAvailabilityAndRating> booksWithAvailability = StreamSupport.stream(books.spliterator(), false)
                .map(book -> {
                    ItemRating rating = ratingService.getRating(book.getId());
                    return new BookWithAvailabilityAndRating(
                            book.getId(),
                            book.getName(),
                            book.getAuthor(),
                            book.getDescription(),
                            rating.getRating(),
                            book.getImagePath(),
                            availabilityClient.inStock(book.getId()));
                })
                .collect(Collectors.toList());
        return booksWithAvailability;
    }

    @RequestMapping(value = "/catalog/borrow", params={"bookId"})
    public String borrow(final HttpServletRequest request) {
        String parameter = request.getParameter("bookId");
        availabilityClient.borrow(Integer.valueOf(parameter).longValue());
        return "redirect:/catalog";
    }
}
````

- And don't forget the tests!

````
package com.oreilly.sacon.library.controllers;

import com.oreilly.sacon.library.availability.AvailabilityClient;
import com.oreilly.sacon.library.catalog.CatalogService;
import com.oreilly.sacon.library.catalog.Item;
import com.oreilly.sacon.library.models.BookWithAvailabilityAndRating;
import com.oreilly.sacon.library.rating.ItemRating;
import com.oreilly.sacon.library.rating.RatingService;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.MvcResult;
import org.springframework.web.servlet.ModelAndView;

import java.util.Arrays;
import java.util.List;

import static org.hamcrest.Matchers.samePropertyValuesAs;
import static org.junit.Assert.assertThat;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@RunWith(SpringRunner.class)
@WebMvcTest(controllers = CatalogController.class)
public class CatalogControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private CatalogService catalogService;
    @MockBean
    private AvailabilityClient availabilityClient;
    @MockBean
    private RatingService ratingService;
    private final String name = "Lorem Ipsum";
    private final String description = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas placerat odio felis, vel bibendum justo pulvinar nec. Nam et consectetur turpis, sed venenatis diam. Nunc consectetur ultrices nisl venenatis venenatis. Integer venenatis suscipit lorem quis varius. Aliquam quis erat erat. Nunc aliquet nulla in turpis imperdiet, eget condimentum tellus ornare. Pellentesque fringilla dictum massa, et dapibus purus elementum vitae. Aliquam erat volutpat. Donec libero ante, molestie porta odio ut, lobortis finibus urna. Aenean interdum massa elit, ut feugiat urna rhoncus eu. Morbi ac ex ut lorem cursus congue. Mauris dignissim libero et ullamcorper bibendum. Ut turpis metus, viverra et cursus eget, suscipit ut arcu. Morbi sit amet vehicula est. Quisque sodales sapien elit, in pharetra erat elementum ut. In hac habitasse platea dictumst.";
    private final int rating = 3;
    private final String imagePath = "http://bulma.io/images/placeholders/640x480.png";
    private final boolean available = true;
    private final String author = "Lorem Ipsum Dolor";

    @Test
    public void shouldReturnAListOfBooks() throws Exception {
        Item item = new Item(name, author, description, imagePath);
        item.setId(1L);
        BookWithAvailabilityAndRating bookWithAvailabilityAndRating = new BookWithAvailabilityAndRating(item.getId(), name, author, description, rating, imagePath, available);
        List<Item> books = Arrays.asList(item);
        when(catalogService.getAllBooks()).thenReturn(books);
        when(availabilityClient.inStock(1L)).thenReturn(available);
        when(ratingService.getRating(1L)).thenReturn(new ItemRating(rating));

        MvcResult mvcResult = mockMvc.perform(get("/catalog"))
                .andExpect(view().name("catalog"))
                .andExpect(status().isOk())
                .andExpect(model().hasNoErrors())
                .andReturn();
        ModelAndView modelAndView = mvcResult.getModelAndView();
        List actualBooks = (List) modelAndView.getModel().get("books");

        assertThat(actualBooks.get(0), samePropertyValuesAs(bookWithAvailabilityAndRating));
    }

    @Test
    public void shouldModifyTheAvailabilityOfTheBookFromAvailableToNot() throws Exception {
        mockMvc.perform(post("/catalog/borrow").param("bookId", "1"))
                .andExpect(status().is3xxRedirection())
                .andExpect(redirectedUrl("/catalog"));
    }
}
````

- If all it's good, it's time to commit the changes
````
$ git add .
$ git commit -m "Modify monolith to use new service"
````

- To run the whole application:
  - Go to `library-monolith` directory and run `./gradlew bootRun`
  - Go to `availability-service` directory and run `./gradlew bootRun`
  - Open the browser in http://localhost:8080

### [Optional] Run tests as part of the Continuous Integration pipeline with TravisCI & check code coverage with Codecov
Push the changes to the remote repo and wait for Travis to run the jobs and Codecov to create the report

````
$ git push
````
